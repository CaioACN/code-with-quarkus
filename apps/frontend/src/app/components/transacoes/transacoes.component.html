<div class="transacoes-container">
  <!-- Header -->
  <div class="transacoes-header">
    <h1>Gestão de Transações</h1>
    <button class="btn-primary" (click)="showForm = !showForm">
      <i class="icon-plus"></i>
      Nova Transação
    </button>
  </div>

  <!-- Formulário de Nova Transação -->
  <div class="form-container" *ngIf="showForm">
    <h2>Nova Transação</h2>
    <form (ngSubmit)="criarTransacao()" #transacaoForm="ngForm">
      <div class="form-grid">
        <div class="form-group">
          <label for="cartaoId">ID do Cartão *</label>
          <input 
            type="number" 
            id="cartaoId" 
            name="cartaoId"
            [(ngModel)]="novaTransacao.cartaoId" 
            required 
            min="1"
            class="form-control">
        </div>

        <div class="form-group">
          <label for="usuarioId">ID do Usuário *</label>
          <input 
            type="number" 
            id="usuarioId" 
            name="usuarioId"
            [(ngModel)]="novaTransacao.usuarioId" 
            required 
            min="1"
            class="form-control">
        </div>

        <div class="form-group">
          <label for="valor">Valor *</label>
          <input 
            type="number" 
            id="valor" 
            name="valor"
            [(ngModel)]="novaTransacao.valor" 
            required 
            min="0.01"
            step="0.01"
            class="form-control">
        </div>

        <div class="form-group">
          <label for="moeda">Moeda *</label>
          <select 
            id="moeda" 
            name="moeda"
            [(ngModel)]="novaTransacao.moeda" 
            required
            class="form-control">
            <option value="BRL">BRL</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
          </select>
        </div>

        <div class="form-group">
          <label for="mcc">MCC</label>
          <input 
            type="text" 
            id="mcc" 
            name="mcc"
            [(ngModel)]="novaTransacao.mcc" 
            pattern="[0-9]{4}"
            maxlength="4"
            class="form-control"
            placeholder="Ex: 5812">
        </div>

        <div class="form-group">
          <label for="categoria">Categoria</label>
          <input 
            type="text" 
            id="categoria" 
            name="categoria"
            [(ngModel)]="novaTransacao.categoria" 
            maxlength="60"
            class="form-control"
            placeholder="Ex: RESTAURANTE">
        </div>

        <div class="form-group">
          <label for="parceiroId">ID do Parceiro</label>
          <input 
            type="number" 
            id="parceiroId" 
            name="parceiroId"
            [(ngModel)]="novaTransacao.parceiroId" 
            min="1"
            class="form-control">
        </div>

        <div class="form-group">
          <label for="dataEvento">Data do Evento *</label>
          <input 
            type="datetime-local" 
            id="dataEvento" 
            name="dataEvento"
            [(ngModel)]="novaTransacao.dataEvento" 
            required
            class="form-control">
        </div>

        <div class="form-group">
          <label for="autorizacao">Autorização</label>
          <input 
            type="text" 
            id="autorizacao" 
            name="autorizacao"
            [(ngModel)]="novaTransacao.autorizacao" 
            class="form-control"
            placeholder="Código de autorização">
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-secondary" (click)="showForm = false; resetarFormulario()">
          Cancelar
        </button>
        <button type="submit" class="btn-primary" [disabled]="!transacaoForm.valid || submitting">
          <span *ngIf="submitting" class="spinner-small"></span>
          {{ submitting ? 'Criando...' : 'Criar Transação' }}
        </button>
      </div>
    </form>
  </div>

  <!-- Filtros -->
  <div class="filtros-container">
    <h3>Filtros</h3>
    <div class="filtros-grid">
      <div class="filtro-group">
        <label for="filtroUsuarioId">ID do Usuário</label>
        <input 
          type="number" 
          id="filtroUsuarioId"
          [(ngModel)]="filtros.usuarioId" 
          min="1"
          class="form-control">
      </div>

      <div class="filtro-group">
        <label for="filtroCartaoId">ID do Cartão</label>
        <input 
          type="number" 
          id="filtroCartaoId"
          [(ngModel)]="filtros.cartaoId" 
          min="1"
          class="form-control">
      </div>

      <div class="filtro-group">
        <label for="filtroStatus">Status</label>
        <select 
          id="filtroStatus"
          [(ngModel)]="filtros.status" 
          class="form-control">
          <option *ngFor="let option of statusOptions" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>

      <div class="filtro-group">
        <label for="filtroDataInicio">Data Início</label>
        <input 
          type="date" 
          id="filtroDataInicio"
          [(ngModel)]="filtros.dataInicio" 
          class="form-control">
      </div>

      <div class="filtro-group">
        <label for="filtroDataFim">Data Fim</label>
        <input 
          type="date" 
          id="filtroDataFim"
          [(ngModel)]="filtros.dataFim" 
          class="form-control">
      </div>

      <div class="filtro-actions">
        <button class="btn-primary" (click)="aplicarFiltros()">
          <i class="icon-search"></i>
          Filtrar
        </button>
        <button class="btn-secondary" (click)="limparFiltros()">
          <i class="icon-clear"></i>
          Limpar
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Carregando transações...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-container">
    <div class="error-message">
      <i class="icon-error"></i>
      <p>{{ error }}</p>
      <button class="btn-retry" (click)="carregarTransacoes()">Tentar Novamente</button>
    </div>
  </div>

  <!-- Tabela de Transações -->
  <div *ngIf="!loading && !error" class="table-container">
    <div class="table-header">
      <h3>Transações ({{ totalElements }} total)</h3>
    </div>

    <div class="table-responsive">
      <table class="transacoes-table">
        <thead>
          <tr>
            <th (click)="ordenar('id')" class="sortable">
              ID
              <i class="sort-icon" [class.asc]="pageRequest.ordenacao === 'id' && pageRequest.direcao === 'ASC'"
                 [class.desc]="pageRequest.ordenacao === 'id' && pageRequest.direcao === 'DESC'"></i>
            </th>
            <th (click)="ordenar('cartaoId')" class="sortable">
              Cartão
              <i class="sort-icon" [class.asc]="pageRequest.ordenacao === 'cartaoId' && pageRequest.direcao === 'ASC'"
                 [class.desc]="pageRequest.ordenacao === 'cartaoId' && pageRequest.direcao === 'DESC'"></i>
            </th>
            <th (click)="ordenar('usuarioId')" class="sortable">
              Usuário
              <i class="sort-icon" [class.asc]="pageRequest.ordenacao === 'usuarioId' && pageRequest.direcao === 'ASC'"
                 [class.desc]="pageRequest.ordenacao === 'usuarioId' && pageRequest.direcao === 'DESC'"></i>
            </th>
            <th (click)="ordenar('valor')" class="sortable">
              Valor
              <i class="sort-icon" [class.asc]="pageRequest.ordenacao === 'valor' && pageRequest.direcao === 'ASC'"
                 [class.desc]="pageRequest.ordenacao === 'valor' && pageRequest.direcao === 'DESC'"></i>
            </th>
            <th>Categoria</th>
            <th (click)="ordenar('status')" class="sortable">
              Status
              <i class="sort-icon" [class.asc]="pageRequest.ordenacao === 'status' && pageRequest.direcao === 'ASC'"
                 [class.desc]="pageRequest.ordenacao === 'status' && pageRequest.direcao === 'DESC'"></i>
            </th>
            <th (click)="ordenar('dataEvento')" class="sortable">
              Data Evento
              <i class="sort-icon" [class.asc]="pageRequest.ordenacao === 'dataEvento' && pageRequest.direcao === 'ASC'"
                 [class.desc]="pageRequest.ordenacao === 'dataEvento' && pageRequest.direcao === 'DESC'"></i>
            </th>
            <th>Pontos</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let transacao of transacoes" class="transacao-row">
            <td>{{ transacao.id }}</td>
            <td>{{ transacao.cartaoId }}</td>
            <td>{{ transacao.usuarioId }}</td>
            <td>{{ formatarValor(transacao.valor) }}</td>
            <td>{{ transacao.categoria || '-' }}</td>
            <td>
              <span class="status-badge" [style.background-color]="obterCorStatus(transacao.status)">
                {{ transacao.status }}
              </span>
            </td>
            <td>{{ formatarData(transacao.dataEvento) }}</td>
            <td>{{ transacao.pontosGerados || '-' }}</td>
            <td>
              <button 
                *ngIf="podeEstornar(transacao)"
                class="btn-action btn-estornar" 
                (click)="estornarTransacao(transacao)"
                title="Estornar transação">
                <i class="icon-undo"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginação -->
    <div class="pagination-container" *ngIf="totalPages > 1">
      <div class="pagination-info">
        Página {{ pageRequest.pagina }} de {{ totalPages }} 
        ({{ totalElements }} registros)
      </div>
      
      <div class="pagination-controls">
        <button 
          class="btn-pagination" 
          [disabled]="pageRequest.pagina === 1"
          (click)="mudarPagina(pageRequest.pagina - 1)">
          <i class="icon-chevron-left"></i>
        </button>

        <button 
          *ngFor="let pagina of paginas"
          class="btn-pagination"
          [class.active]="pagina === pageRequest.pagina"
          (click)="mudarPagina(pagina)">
          {{ pagina }}
        </button>

        <button 
          class="btn-pagination" 
          [disabled]="pageRequest.pagina === totalPages"
          (click)="mudarPagina(pageRequest.pagina + 1)">
          <i class="icon-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>
</div>
